@* ITM.Dashboard.Web.Client/Pages/ProcessMemory.razor *@
@page "/process-memory"
@using ITM.Dashboard.Web.Client.Models
@using ITM.Dashboard.Web.Client.Shared
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar

<PageTitle>Process Performance</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
    <MudIcon Icon="@Icons.Material.Rounded.Memory" Size="Size.Large" />
    <MudText Typo="Typo.h4">Process Memory</MudText>
</MudStack>

<MudPaper Class="pa-4 mb-4">
    <MudGrid Spacing="2" AlignItems="AlignItems.Center">
        <MudItem xs="12" sm="4" md="2">
            <MudSelect T="string" Label="Site" Value="_selectedSite" ValueChanged="OnSiteChanged" Dense="true" Margin="Margin.Dense" Required="true">
                @foreach (var site in _sites)
                {
                    <MudSelectItem T="string" Value="@site">@site</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="4" md="2">
            <MudSelect T="string" Label="SDWT" Value="_selectedSdwt" ValueChanged="OnSdwtChanged" Disabled="@(string.IsNullOrEmpty(_selectedSite))" Dense="true" Margin="Margin.Dense" Required="true">
                @foreach (var sdwt in _sdwts)
                {
                    <MudSelectItem T="string" Value="@sdwt">@sdwt</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="4" md="2">
            <MudAutocomplete T="string" Label="EQP ID" @bind-Value="_selectedEqpId" SearchFunc="SearchEqpids"
                             ResetValueOnEmptyText="true" CoerceText="false" CoerceValue="false" Dense="true" Margin="Margin.Dense"
                             Required="true" Disabled="@(string.IsNullOrEmpty(_selectedSdwt) || _isEqpIdListLoading)" />
        </MudItem>
        <MudItem xs="6" sm="6" md="2">
            <MudDatePicker Label="Start Date" @bind-Date="_startDate" Dense="true" Margin="Margin.Dense" />
        </MudItem>
        <MudItem xs="6" sm="6" md="2">
            <MudDatePicker Label="End Date" @bind-Date="_endDate" Dense="true" Margin="Margin.Dense" />
        </MudItem>
        <MudItem xs="6" sm="6" md="1">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnSearchClicked" Disabled="@(string.IsNullOrEmpty(_selectedEqpId))" FullWidth="true">Search</MudButton>
        </MudItem>
        <MudItem xs="6" sm="6" md="1">
            <MudButton Variant="Variant.Outlined" OnClick="ResetFilters" FullWidth="true">Reset</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_isLoading)
{
    <div class="d-flex justify-center mt-16">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </div>
}
else if (_isSearched)
{
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h6" GutterBottom="true">@_searchedEqpId Process Memory Trend (Peak Top 5)</MudText>
        @if (_processChartData.Any())
        {
            <AmChart ChartData="_processChartData" ChartConfig="_processMemoryChartConfig" ChartType="ProcessMemoryChart" Height="500px" />
        }
        else
        {
            <div class="d-flex justify-center align-center" style="height:500px;"><MudText>조회된 기간 내에 프로세스 성능 데이터가 없습니다.</MudText></div>
        }
    </MudPaper>
}
else
{
    <MudAlert Severity="Severity.Info">조회할 장비를 선택 후, Search 버튼을 클릭하세요.</MudAlert>
}


@code {
    private bool _isLoading = false;
    private bool _isSearched = false;
    private bool _isEqpIdListLoading = false; // [추가] EQPID 목록 로딩 상태

    private string? _selectedSite;
    private string? _selectedSdwt;
    private string? _selectedEqpId;
    private string? _searchedEqpId; // [추가] 검색 완료된 EQP ID 저장용

    private DateTime? _startDate = DateTime.Now.Date.AddDays(-1);
    private DateTime? _endDate = DateTime.Now.Date;

    private List<string> _sites = new();
    private List<string> _sdwts = new();
    private List<string> _availableEqpIds = new();
    private List<ProcessMemoryDataDto> _processChartData = new();
    private object _processMemoryChartConfig = new { };
    protected override async Task OnInitializedAsync()
    {
        var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
        _sites = await client.GetFromJsonAsync<List<string>>("api/Filters/sites") ?? new();
    }

    private async Task OnSiteChanged(string newSite)
    {
        _selectedSite = newSite;
        await ResetDependentFilters("site");
    }

    private async Task OnSdwtChanged(string newSdwt)
    {
        _selectedSdwt = newSdwt;
        await ResetDependentFilters("sdwt");
    }

    private async Task ResetDependentFilters(string level)
    {
        if (level == "site")
        {
            _selectedSdwt = null;
            _sdwts.Clear();
        }
        _selectedEqpId = null;
        _availableEqpIds.Clear();

        if (string.IsNullOrEmpty(_selectedSite)) return;

        var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
        if (level == "site")
        {
            _sdwts = await client.GetFromJsonAsync<List<string>>($"api/Filters/sdwts/{_selectedSite}") ?? new();
        }

        // ▼▼▼ [수정] EQPID 목록 로드 전/후로 _isEqpIdListLoading 상태 관리 ▼▼▼
        if (!string.IsNullOrEmpty(_selectedSdwt))
        {
            _isEqpIdListLoading = true; // 1. 로딩 시작 (필터 비활성화)
            StateHasChanged();

            _availableEqpIds = await client.GetFromJsonAsync<List<string>>($"api/Filters/eqpids/performance/{_selectedSdwt}") ?? new();

            _isEqpIdListLoading = false; // 2. 로딩 완료 (필터 활성화)
        }

        StateHasChanged();
    }

    private async Task<IEnumerable<string>> SearchEqpids(string value, CancellationToken token)
    {
        await Task.Yield();
        if (string.IsNullOrEmpty(value) || value == _selectedEqpId)
        {
            return _availableEqpIds;
        }
        return _availableEqpIds.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task OnSearchClicked()
    {
        if (string.IsNullOrEmpty(_selectedEqpId) || _startDate == null || _endDate == null) return;
        _isLoading = true;
        _isSearched = false;
        _searchedEqpId = _selectedEqpId; // [추가] 검색 버튼 클릭 시 EQP ID 확정
        _processChartData.Clear();
        await InvokeAsync(StateHasChanged);

        var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
        try
        {
            var query = new System.Text.StringBuilder();
            query.Append($"startDate={Uri.EscapeDataString(_startDate.Value.ToString("o"))}");
            query.Append($"&endDate={Uri.EscapeDataString(_endDate.Value.AddDays(1).AddTicks(-1).ToString("o"))}");
            query.Append($"&eqpid={Uri.EscapeDataString(_selectedEqpId)}");

            var data = await client.GetFromJsonAsync<List<ProcessMemoryDataDto>>($"api/PerformanceAnalytics/process-history?{query}");

            if (data != null && data.Any())
            {
                // 1. 기간 내 최고 사용량 기준 Top 5 프로세스 선정
                var top5ByPeak = data
                    .GroupBy(d => d.ProcessName)
                    .Select(g => new { ProcessName = g.Key, MaxMem = g.Max(d => d.MemoryUsageMB) })
                    .OrderByDescending(x => x.MaxMem)
                    .Take(5)
                    .Select(x => x.ProcessName);

                // 2. 가장 최근 시점 기준 Top 5 프로세스 선정
                var latestTimestamp = data.Max(d => d.Timestamp);
                var top5ByLatest = data
                    .Where(d => d.Timestamp == latestTimestamp)
                    .OrderByDescending(d => d.MemoryUsageMB)
                    .Take(5)
                    .Select(d => d.ProcessName);

                // 3. 두 목록을 합쳐서 차트에 표시할 최종 프로세스 목록 생성
                var processNamesToShow = top5ByPeak.Union(top5ByLatest).ToHashSet();

                // 4. 최종 목록에 포함된 프로세스의 데이터만 필터링
                _processChartData = data.Where(d => processNamesToShow.Contains(d.ProcessName)).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"프로세스 데이터 조회 중 오류 발생: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSearched = true;
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ResetFilters()
    {
        _selectedSite = null;
        _selectedSdwt = null;
        _selectedEqpId = null;
        _searchedEqpId = null; // [추가] 리셋 시 검색된 EQP ID도 초기화
        _startDate = DateTime.Now.Date.AddDays(-1);
        _endDate = DateTime.Now.Date;
        _sdwts.Clear();
        _availableEqpIds.Clear();

        _isSearched = false;
        _processChartData.Clear();
        await InvokeAsync(StateHasChanged);
    }
}
