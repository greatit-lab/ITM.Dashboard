@* // ITM.Dashboard.Web.Client/Pages/ErrorAnalytics.razor *@
@page "/error-analytics"
@using ITM.Dashboard.Web.Client.Models
@using ITM.Dashboard.Web.Client.Shared
@inject IHttpClientFactory HttpClientFactory

<PageTitle>Error Analytics</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
    <MudIcon Icon="@Icons.Material.Rounded.Warning" Size="Size.Large" />
    <MudText Typo="Typo.h4">Error Analytics</MudText>
</MudStack>

<MudPaper Class="pa-4 mb-4">
    <MudGrid Spacing="2" AlignItems="AlignItems.Center">
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="string" Label="Site" Value="_selectedSite" ValueChanged="OnSiteChanged" Dense="true" Margin="Margin.Dense" Required="true" RequiredError="Site를 선택하세요.">
                @foreach (var site in _sites)
                {
                    <MudSelectItem T="string" Value="@site">@site</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6" md="2">
            <MudSelect T="string" Label="SDWT (전체)" Value="_selectedSdwt" ValueChanged="OnSdwtChanged" Disabled="@(string.IsNullOrEmpty(_selectedSite))" Dense="true" Margin="Margin.Dense" Clearable="true">
                @foreach (var sdwt in _sdwts)
                {
                    <MudSelectItem T="string" Value="@sdwt">@sdwt</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="12" md="3">
            <MudAutocomplete T="string" Label="EQP ID (전체)" @bind-Value="_selectedEqpId" SearchFunc="SearchEqpids"
                             ResetValueOnEmptyText="true" CoerceText="false" CoerceValue="false" Dense="true" Margin="Margin.Dense"
                             Disabled="@(string.IsNullOrEmpty(_selectedSite))" />
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudDateRangePicker @bind-DateRange="_dateRange" Label="기간 선택" Dense="true" Margin="Margin.Dense" />
        </MudItem>
        @* ▼▼▼ [수정] 조회/Reset 버튼 레이아웃 변경 ▼▼▼ *@
        <MudItem xs="6" sm="3" md="1">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnSearchClicked" Disabled="@(string.IsNullOrEmpty(_selectedSite))" FullWidth="true">조회</MudButton>
        </MudItem>
        <MudItem xs="6" sm="3" md="1">
            <MudButton Variant="Variant.Outlined" OnClick="ResetFilters" FullWidth="true">Reset</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_isLoading)
{
    <div class="d-flex justify-center mt-4">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </div>
}
else if (_isSearched)
{
    <MudGrid Spacing="3">
        @* KPI Cards *@
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Style="height:100%"><MudText Typo="Typo.subtitle1">Total Error 발생건</MudText><MudText Typo="Typo.h4" Color="Color.Error">@_summary?.TotalErrorCount</MudText></MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Class="pa-4" Style="height:100%"><MudText Typo="Typo.subtitle1">Error 발생 장비수</MudText><MudText Typo="Typo.h4">@_summary?.ErrorEqpCount</MudText></MudPaper>
        </MudItem>
        <MudItem xs="12" sm="12" md="6">
            <MudPaper Class="pa-4" Style="height:100%">
                <MudText Typo="Typo.subtitle1">최다 발생 Error</MudText>
                <MudText Typo="Typo.h5">
                    @_summary?.TopErrorId
                    @if (!string.IsNullOrEmpty(_summary?.TopErrorLabel))
                    {
                        <MudText Inline="true" Typo="Typo.h6" Class="ml-2 mud-text-secondary">@_summary.TopErrorLabel</MudText>
                    }
                </MudText>
                <MudText>@_summary?.TopErrorCount 건</MudText>
            </MudPaper>
        </MudItem>

        @* Charts *@
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4" Style="height:100%">
                <MudText Typo="Typo.h6" GutterBottom="true">Error 발생 Time Trend</MudText>
                <AmChart ChartType="XYChart" ChartData="_trendData" ChartConfig="_trendChartConfig" Height="200px" />
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4" Style="height:100%">
                <MudText Typo="Typo.h6" GutterBottom="true">장비별 에러 발생 현황</MudText>
                @if (_summary?.ErrorCountByEqp?.Any() == true)
                {
                    <AmChart ChartType="PieChart" ChartData="_summary.ErrorCountByEqp" ChartConfig="_donutChartConfig" Height="200px" />
                }
                else
                {
                    <div class="d-flex justify-center align-center" style="height:200px;"><MudText>데이터 없음</MudText></div>
                }
            </MudPaper>
        </MudItem>

        @* Data Grid *@
        <MudItem xs="12">
            <MudDataGrid T="ErrorLogDto" ServerData="LoadGridData" @ref="_grid" Dense="true" Hover="true" Striped="true" RowsPerPage="10">
                <Columns>
                    <PropertyColumn Property="x => x.TimeStamp" Title="Error Time" Format="yy-MM-dd HH:mm:ss" />
                    <PropertyColumn Property="x => x.EqpId" Title="EQP ID" />
                    <PropertyColumn Property="x => x.ErrorId" Title="Error ID" />
                    <PropertyColumn Property="x => x.ErrorLabel" Title="Error Label" />
                    <PropertyColumn Property="x => x.ErrorDesc" Title="Error Description" />
                    <PropertyColumn Property="x => x.ExtraMessage1" Title="Extra Message 1" />
                    <PropertyColumn Property="x => x.ExtraMessage2" Title="Extra Message 2" />
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="ErrorLogDto" />
                </PagerContent>
            </MudDataGrid>
        </MudItem>
    </MudGrid>
}
else
{
    <MudAlert Severity="Severity.Info">조회할 Site를 선택 후, 조회 버튼을 클릭하세요.</MudAlert>
}

@code {
    private bool _isLoading = false;
    private bool _isSearched = false;
    private MudDataGrid<ErrorLogDto> _grid;

    private DateRange _dateRange = new DateRange(DateTime.Now.Date.AddDays(-14), DateTime.Now.Date);

    private List<string> _sites = new();
    private List<string> _sdwts = new();
    private List<string> _eqpIds = new();

    private string _selectedSite;
    private string _selectedSdwt;
    private string _selectedEqpId;

    private ErrorAnalyticsSummaryDto _summary = new();
    private List<ErrorTrendDataPointDto> _trendData = new();

    private object _trendChartConfig;
    private object _donutChartConfig;

    protected override async Task OnInitializedAsync()
    {
        _trendChartConfig = new
        {
            xField = "date",
            xTimeUnit = "day",
            xAxisDateFormat = "yy-MM-dd",
            yAxisMin = 0,
            yAxisForceInteger = true,
            series = new[]
            {
                new { name = "에러 건수", valueField = "count" }
            }
        };

        _donutChartConfig = new
        {
            valueField = "value",
            categoryField = "label"
        };

        await LoadSites();
    }

    private async Task LoadSites()
    {
        var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
        _sites = await client.GetFromJsonAsync<List<string>>("api/Filters/sites") ?? new();
    }

    private async Task OnSiteChanged(string newSite)
    {
        _selectedSite = newSite;
        _selectedSdwt = null;
        _selectedEqpId = null;
        _sdwts.Clear();
        _eqpIds.Clear();
        if (!string.IsNullOrEmpty(_selectedSite))
        {
            var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
            _sdwts = await client.GetFromJsonAsync<List<string>>($"api/Filters/sdwts/{_selectedSite}") ?? new();
            // Site 변경 시 EQPID 목록도 바로 로드
            _eqpIds = await client.GetFromJsonAsync<List<string>>($"api/Filters/eqpidsbysite/{_selectedSite}") ?? new();
        }
    }

    private async Task OnSdwtChanged(string newSdwt)
    {
        _selectedSdwt = newSdwt;
        _selectedEqpId = null;
        _eqpIds.Clear();
        if (!string.IsNullOrEmpty(_selectedSite))
        {
            var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
            var url = string.IsNullOrEmpty(_selectedSdwt)
                ? $"api/Filters/eqpidsbysite/{_selectedSite}"
                : $"api/Filters/eqpids/{_selectedSdwt}";

            _eqpIds = await client.GetFromJsonAsync<List<string>>(url) ?? new();
        }
    }

    private async Task<IEnumerable<string>> SearchEqpids(string value, CancellationToken token)
    {
        await Task.Yield();
        if (string.IsNullOrEmpty(value)) return _eqpIds;
        return _eqpIds.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    // ▼▼▼ [핵심 수정] 조회 버튼 클릭 로직을 개선합니다. ▼▼▼
    private async Task OnSearchClicked()
    {
        // 1. 로딩 상태 시작, 이전 결과 숨김
        _isLoading = true;
        _isSearched = false;
        await InvokeAsync(StateHasChanged); // UI 즉시 업데이트

        var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
        var query = BuildQueryString();
        try
        {
            var summaryTask = client.GetFromJsonAsync<ErrorAnalyticsSummaryDto>($"api/ErrorAnalytics/summary?{query}");
            var trendTask = client.GetFromJsonAsync<List<ErrorTrendDataPointDto>>($"api/ErrorAnalytics/trend?{query}");

            await Task.WhenAll(summaryTask, trendTask);

            // 2. 데이터 변수에 결과 할당
            _summary = await summaryTask ?? new ErrorAnalyticsSummaryDto();
            _trendData = await trendTask ?? new List<ErrorTrendDataPointDto>();

            // 3. 데이터 로딩이 완료된 후, 결과 표시 플래그를 true로 설정
            _isSearched = true;

            // 데이터 그리드 갱신
            if (_grid != null)
            {
                await _grid.ReloadServerData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading analytics data: {ex.Message}");
            _summary = new ErrorAnalyticsSummaryDto();
            _trendData = new List<ErrorTrendDataPointDto>();
        }
        finally
        {
            // 4. 로딩 상태 종료 및 최종 UI 갱신
            _isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task ResetFilters()
    {
        _selectedSite = null;
        _selectedSdwt = null;
        _selectedEqpId = null;
        _dateRange = new DateRange(DateTime.Now.Date.AddDays(-6), DateTime.Now.Date);

        _sdwts.Clear();
        _eqpIds.Clear();

        _isSearched = false;
        _summary = new();
        _trendData = new();

        if (_grid != null)
        {
            await _grid.ReloadServerData();
        }
    }

    private async Task<GridData<ErrorLogDto>> LoadGridData(GridState<ErrorLogDto> state)
    {
        if (!_isSearched)
            return new GridData<ErrorLogDto> { Items = new List<ErrorLogDto>(), TotalItems = 0 };

        var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
        var query = BuildQueryString();
        var dataUrl = $"api/ErrorAnalytics/logs?{query}&page={state.Page}&pageSize={state.PageSize}";

        try
        {
            var pagedResult = await client.GetFromJsonAsync<PagedResult<ErrorLogDto>>(dataUrl);
            if (pagedResult != null)
            {
                return new GridData<ErrorLogDto>
                {
                    Items = pagedResult.Items,
                    TotalItems = (int)pagedResult.TotalItems
                };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading grid data: {ex.Message}");
        }

        return new GridData<ErrorLogDto> { Items = new List<ErrorLogDto>(), TotalItems = 0 };
    }

    private string BuildQueryString()
    {
        var startDate = _dateRange.Start?.ToString("o") ?? "";
        var endDate = _dateRange.End?.ToString("o") ?? "";

        var queryParams = new System.Text.StringBuilder();
        queryParams.Append($"startDate={Uri.EscapeDataString(startDate)}");
        queryParams.Append($"&endDate={Uri.EscapeDataString(endDate)}");

        if (!string.IsNullOrEmpty(_selectedSite)) queryParams.Append($"&site={Uri.EscapeDataString(_selectedSite)}");
        if (!string.IsNullOrEmpty(_selectedSdwt)) queryParams.Append($"&sdwt={Uri.EscapeDataString(_selectedSdwt)}");

        if (!string.IsNullOrEmpty(_selectedEqpId))
        {
            queryParams.Append($"&eqpids={Uri.EscapeDataString(_selectedEqpId)}");
        }

        return queryParams.ToString();
    }
}
