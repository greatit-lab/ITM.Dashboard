@* ITM.Dashboard.Web.Client/Pages/PreAlignAnalytics.razor *@
@page "/prealign-analytics"
@using ITM.Dashboard.Web.Client.Models
@inject IHttpClientFactory HttpClientFactory

<PageTitle>Pre-Align Analytics</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-2">
    <MudIcon Icon="@Icons.Material.Rounded.GpsFixed" Size="Size.Large" />
    <MudText Typo="Typo.h4">Pre-Align 분석</MudText>
</MudStack>

<MudPaper Class="pa-4 mb-4">
    <MudGrid Spacing="2" AlignItems="AlignItems.Center">
        <MudItem xs="6" sm="4" md="2">
            <MudSelect T="string" Label="Site" Value="_selectedSite" ValueChanged="OnSiteChanged" Dense="true" Margin="Margin.Dense">
                @foreach (var site in _sites)
                {
                    <MudSelectItem T="string" Value="@site">@site</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="6" sm="4" md="2">
            <MudSelect T="string" Label="SDWT" Value="_selectedSdwt" ValueChanged="OnSdwtChanged" Disabled="@(string.IsNullOrEmpty(_selectedSite))" Dense="true" Margin="Margin.Dense">
                @foreach (var sdwt in _sdwts)
                {
                    <MudSelectItem T="string" Value="@sdwt">@sdwt</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="4" md="2">
            <MudAutocomplete T="string" Label="EQP ID" @bind-Value="_selectedEqpId" SearchFunc="SearchEqpids"
                             ResetValueOnEmptyText="true" CoerceText="false" CoerceValue="false" Dense="true" Margin="Margin.Dense"
                             Disabled="@(string.IsNullOrEmpty(_selectedSite))" />
        </MudItem>
        <MudItem xs="6" sm="6" md="2">
            <MudDatePicker Label="Start Date" @bind-Date="_startDate" Dense="true" Margin="Margin.Dense" />
        </MudItem>
        <MudItem xs="6" sm="6" md="2">
            <MudDatePicker Label="End Date" @bind-Date="_endDate" Dense="true" Margin="Margin.Dense" />
        </MudItem>
        <MudItem xs="6" sm="6" md="1">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OnSearchClicked" Disabled="@(string.IsNullOrEmpty(_selectedEqpId))" FullWidth="true">Search</MudButton>
        </MudItem>
        <MudItem xs="6" sm="6" md="1">
            <MudButton Variant="Variant.Outlined" OnClick="ResetFilters" FullWidth="true">Reset</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_isLoading)
{
    <div class="d-flex justify-center mt-4">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </div>
}
else if (_isSearched)
{
    <MudGrid Spacing="3">
        <!-- X-Y 편차 -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">X-Y 편차 트렌드</MudText>

                    @if (_xyDeviationSeries.Any())
                    {
                        <MudChart ChartType="ChartType.Line"
                                  ChartSeries="_xyDeviationSeries"
                                  XAxisLabels="_chartXAxisLabels"
                                  Height="400px"
                                  Options="_xyChartJsOptions" />

                        <!-- Y축 슬라이더 -->
                        <MudRangeSlider Range="_xyRange" RangeChanged="OnXyRangeChanged"
                                        Min="@_overallXyMin" Max="@_overallXyMax" Step="0.0001" />
                        <div>
                            Y축 범위:
                            <MudChip T="object" Size="Size.Small" Color="Color.Primary">@_xyRange.Start.ToString("F4")</MudChip> ~
                            <MudChip T="object" Size="Size.Small" Color="Color.Primary">@_xyRange.End.ToString("F4")</MudChip>
                        </div>

                        <!-- X축 슬라이더 -->
                        <MudRangeSlider Range="_xIndexRange" RangeChanged="OnXIndexRangeChanged"
                                        Min="0" Max="@(_rawData.Count - 1)" Step="1" />
                        <div>
                            X축 범위:
                            <MudChip T="object" Size="Size.Small" Color="Color.Secondary">@_chartXAxisLabels.FirstOrDefault()</MudChip> ~
                            <MudChip T="object" Size="Size.Small" Color="Color.Secondary">@_chartXAxisLabels.LastOrDefault()</MudChip>
                        </div>
                    }
                    else
                    {
                        <MudText>데이터가 없습니다.</MudText>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>

        <!-- Notch -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">Notch 값 트렌드</MudText>

                    @if (_notchSeries.Any())
                    {
                        <MudChart ChartType="ChartType.Line"
                                  ChartSeries="_notchSeries"
                                  XAxisLabels="_chartXAxisLabels"
                                  Height="400px"
                                  Options="_notchChartJsOptions" />

                        <!-- Y축 슬라이더 -->
                        <MudRangeSlider Range="_notchRange" RangeChanged="OnNotchRangeChanged"
                                        Min="@_overallNotchMin" Max="@_overallNotchMax" Step="0.0001" />
                        <div>
                            Y축 범위:
                            <MudChip T="object" Size="Size.Small" Color="Color.Primary">@_notchRange.Start.ToString("F4")</MudChip> ~
                            <MudChip T="object" Size="Size.Small" Color="Color.Primary">@_notchRange.End.ToString("F4")</MudChip>
                        </div>

                        <!-- X축 슬라이더 (Notch 차트도 동일 적용) -->
                        <MudRangeSlider Range="_xIndexRange" RangeChanged="OnXIndexRangeChanged"
                                        Min="0" Max="@(_rawData.Count - 1)" Step="1" />
                        <div>
                            X축 범위:
                            <MudChip T="object" Size="Size.Small" Color="Color.Secondary">@_chartXAxisLabels.FirstOrDefault()</MudChip> ~
                            <MudChip T="object" Size="Size.Small" Color="Color.Secondary">@_chartXAxisLabels.LastOrDefault()</MudChip>
                        </div>
                    }
                    else
                    {
                        <MudText>데이터가 없습니다.</MudText>
                    }
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
}
else
{
    <MudAlert Severity="Severity.Info">조회할 장비를 선택 후, 조회 버튼을 클릭하세요.</MudAlert>
}

@code {
    private bool _isLoading = false;
    private bool _isSearched = false;

    private string? _selectedSite;
    private string? _selectedSdwt;
    private string? _selectedEqpId;
    private DateTime? _startDate = DateTime.Now.Date.AddDays(-6);
    private DateTime? _endDate = DateTime.Now.Date;

    private List<string> _sites = new();
    private List<string> _sdwts = new();
    private List<string> _availableEqpIds = new();

    private List<PreAlignDataDto> _rawData = new();
    private List<ChartSeries> _xyDeviationSeries = new();
    private List<ChartSeries> _notchSeries = new();
    private string[] _chartXAxisLabels = Array.Empty<string>();

    private object _xyChartJsOptions = new();
    private object _notchChartJsOptions = new();

    private Range<double> _xyRange = new(0, 1);
    private double _overallXyMin = 0;
    private double _overallXyMax = 1;

    private Range<double> _notchRange = new(0, 1);
    private double _overallNotchMin = 0;
    private double _overallNotchMax = 1;

    private Range<int> _xIndexRange = new(0, 1);

    protected override async Task OnInitializedAsync()
    {
        var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
        _sites = await client.GetFromJsonAsync<List<string>>("api/Filters/sites") ?? new();
    }

    private void OnXyRangeChanged(Range<double> newRange)
    {
        _xyRange = newRange;
        ApplyAxisRanges();
    }

    private void OnNotchRangeChanged(Range<double> newRange)
    {
        _notchRange = newRange;
        ApplyAxisRanges();
    }

    private void OnXIndexRangeChanged(Range<int> newRange)
    {
        _xIndexRange = newRange;
        ApplyAxisRanges();
        ApplyXFilter();
    }

    private void ApplyAxisRanges()
    {
        _xyChartJsOptions = new { scales = new { y = new { min = _xyRange.Start, max = _xyRange.End } } };
        _notchChartJsOptions = new { scales = new { y = new { min = _notchRange.Start, max = _notchRange.End } } };
        StateHasChanged();
    }

    private async Task OnSiteChanged(string newSite)
    {
        _selectedSite = newSite;
        await ResetDependentFilters("site");
    }

    private async Task OnSdwtChanged(string newSdwt)
    {
        _selectedSdwt = newSdwt;
        await ResetDependentFilters("sdwt");
    }

    private async Task ResetDependentFilters(string level)
    {
        if (level == "site")
        {
            _selectedSdwt = null;
            _sdwts.Clear();
        }
        _selectedEqpId = null;
        _availableEqpIds.Clear();

        if (!string.IsNullOrEmpty(_selectedSite))
        {
            var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
            if (level == "site")
            {
                _sdwts = await client.GetFromJsonAsync<List<string>>($"api/Filters/sdwts/{_selectedSite}") ?? new();
            }
            
            var url = string.IsNullOrEmpty(_selectedSdwt)
                ? $"api/Filters/eqpidsbysite/{_selectedSite}"
                : $"api/Filters/eqpids/{_selectedSdwt}";
            _availableEqpIds = await client.GetFromJsonAsync<List<string>>(url) ?? new();
        }
        StateHasChanged();
    }

    private async Task ResetDependentFilters(string level)
    {
        if (level == "site") { _selectedSdwt = null; _sdwts.Clear(); }
        _selectedEqpId = null;
        _availableEqpIds.Clear();
        if (!string.IsNullOrEmpty(_selectedSite))
        {
            var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
            if (level == "site") { _sdwts = await client.GetFromJsonAsync<List<string>>($"api/Filters/sdwts/{_selectedSite}") ?? new(); }
            var url = string.IsNullOrEmpty(_selectedSdwt) ? $"api/Filters/eqpidsbysite/{_selectedSite}" : $"api/Filters/eqpids/{_selectedSdwt}";
            _availableEqpIds = await client.GetFromJsonAsync<List<string>>(url) ?? new();
        }
        StateHasChanged();
    }

    private async Task<IEnumerable<string>> SearchEqpids(string value, CancellationToken token)
    {
        await Task.Yield();
        if (string.IsNullOrEmpty(value)) return _availableEqpIds;
        return _availableEqpIds.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase));
    }

    private async Task OnSearchClicked()
    {
        if (string.IsNullOrEmpty(_selectedEqpId) || _startDate == null || _endDate == null) return;

        _isLoading = true;
        _isSearched = true;
        ClearResults();
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient("ITM.Dashboard.Api");
            var query = $"eqpid={Uri.EscapeDataString(_selectedEqpId)}&startDate={_startDate.Value:yyyy-MM-dd}&endDate={_endDate.Value:yyyy-MM-dd}";
            var data = await client.GetFromJsonAsync<List<PreAlignDataDto>>($"api/PreAlignAnalytics/data?{query}");

            if (data != null && data.Any())
            {
                _rawData = data;
                _xIndexRange = new Range<int>(0, _rawData.Count -1);
                PrepareChartData(data);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading Pre-Align Analytics data: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ResetFilters()
    {
        _selectedSite = null;
        _selectedSdwt = null;
        _selectedEqpId = null;
        _startDate = DateTime.Now.Date.AddDays(-6);
        _endDate = DateTime.Now.Date;
        _sdwts.Clear();
        _availableEqpIds.Clear();
        _isSearched = false;
        ClearResults();
        
        _xyRange = new Range<double>(0, 1);
        _notchRange = new Range<double>(0, 1);
        _xIndexRange = new Range<int>(0, 1);
        ApplyAxisRanges();

        StateHasChanged();
    }

    private void ClearResults()
    {
        _rawData.Clear();
        _xyDeviationSeries.Clear();
        _notchSeries.Clear();
        _chartXAxisLabels = Array.Empty<string>();
    }

    private void PrepareChartData()
    {
        ApplyXFilter();

        var xmmData = _rawData.Select(d => d.Xmm);
        var ymmData = _rawData.Select(d => d.Ymm);
        _overallXyMin = Math.Min(xmmData.Min(), ymmData.Min());
        _overallXyMax = Math.Max(xmmData.Max(), ymmData.Max());
        _xyRange = new Range<double>(_overallXyMin, _overallXyMax);

        var notchData = _rawData.Select(d => d.Notch);
        _overallNotchMin = notchData.Min();
        _overallNotchMax = notchData.Max();
        _notchRange = new Range<double>(_overallNotchMin, _overallNotchMax);

        ApplyAxisRanges();
    }

    private void ApplyXFilter()
    {
        if (_rawData.Count == 0) return;

        var start = Math.Max(0, _xIndexRange.Start);
        var end = Math.Min(_rawData.Count - 1, _xIndexRange.End);

        var filtered = _rawData.Skip(start).Take(end - start + 1).ToList();

        _xyDeviationSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Xmm", Data = filtered.Select(d => d.Xmm).ToArray() },
            new ChartSeries { Name = "Ymm", Data = filtered.Select(d => d.Ymm).ToArray() }
        };

        _notchSeries = new List<ChartSeries>
        {
            new ChartSeries { Name = "Notch", Data = filtered.Select(d => d.Notch).ToArray() }
        };

        _chartXAxisLabels = filtered.Select(d => d.Timestamp.ToString("MM-dd HH:mm")).ToArray();
    }
}
